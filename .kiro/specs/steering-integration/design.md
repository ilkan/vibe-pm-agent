# Design Document

## Overview

The Steering Integration feature extends the PM Agent Intent-to-Spec Optimizer to automatically convert its generated consulting documents into Kiro steering files. This creates a self-improving development environment where the PM agent's consulting expertise becomes persistent guidance for future development work.

The system will intercept PM agent document generation, format the outputs as steering files with appropriate front-matter, and save them to the `.kiro/steering/` directory with intelligent naming and inclusion rules.

## Architecture

### Core Components

1. **SteeringFileGenerator**: Converts PM agent outputs to steering file format
2. **SteeringFileManager**: Handles file naming, organization, and conflict resolution
3. **FrontMatterProcessor**: Generates appropriate front-matter for different document types
4. **DocumentReferenceLinker**: Creates cross-references between related steering files

### Integration Points

- **MCP Tool Handlers**: Extended to optionally save outputs as steering files
- **PM Document Generator**: Enhanced with steering file generation capabilities
- **AI Agent Pipeline**: Modified to support steering file creation workflow

## Components and Interfaces

### SteeringFileGenerator Interface

```typescript
interface SteeringFileGenerator {
  generateFromRequirements(requirements: string, context: SteeringContext): SteeringFile;
  generateFromDesign(design: string, context: SteeringContext): SteeringFile;
  generateFromOnePager(onePager: string, context: SteeringContext): SteeringFile;
  generateFromPRFAQ(prfaq: string, context: SteeringContext): SteeringFile;
  generateFromTaskPlan(taskPlan: string, context: SteeringContext): SteeringFile;
}

interface SteeringContext {
  featureName: string;
  projectName?: string;
  relatedFiles: string[];
  inclusionRule: 'always' | 'fileMatch' | 'manual';
  fileMatchPattern?: string;
}

interface SteeringFile {
  filename: string;
  frontMatter: FrontMatter;
  content: string;
  references: string[];
}

interface FrontMatter {
  inclusion: 'always' | 'fileMatch' | 'manual';
  fileMatchPattern?: string;
  generatedBy: string;
  generatedAt: string;
  featureName: string;
  documentType: 'requirements' | 'design' | 'onepager' | 'prfaq' | 'tasks';
}
```

### SteeringFileManager Interface

```typescript
interface SteeringFileManager {
  saveSteeringFile(steeringFile: SteeringFile): Promise<SaveResult>;
  checkConflicts(filename: string): ConflictInfo;
  resolveNaming(baseName: string, documentType: string): string;
  listExistingSteeringFiles(): string[];
}

interface SaveResult {
  success: boolean;
  filename: string;
  action: 'created' | 'updated' | 'versioned';
  message: string;
}

interface ConflictInfo {
  exists: boolean;
  existingFile?: string;
  suggestedAction: 'update' | 'version' | 'rename';
}
```

## Data Models

### Steering File Templates

#### Requirements Steering File Template
```markdown
---
inclusion: fileMatch
fileMatchPattern: 'requirements*|spec*'
generatedBy: pm-agent-intent-optimizer
generatedAt: {timestamp}
featureName: {feature_name}
documentType: requirements
---

# Requirements Guidance: {Feature Name}

This guidance was generated by the PM Agent Intent-to-Spec Optimizer and contains consulting-grade requirements analysis.

## Business Context
{extracted business context}

## Key Requirements
{formatted requirements with MoSCoW prioritization}

## Related Documents
#[[file:.kiro/specs/{feature_name}/design.md]]
#[[file:.kiro/specs/{feature_name}/tasks.md]]

## Consulting Insights
{consulting technique insights}
```

#### Design Options Steering File Template
```markdown
---
inclusion: fileMatch
fileMatchPattern: 'design*|architecture*'
generatedBy: pm-agent-intent-optimizer
generatedAt: {timestamp}
featureName: {feature_name}
documentType: design
---

# Design Guidance: {Feature Name}

This guidance contains Impact vs Effort analysis and design options from PM Agent consulting analysis.

## Design Options
{Conservative/Balanced/Bold options}

## Impact vs Effort Matrix
{matrix analysis}

## Related Documents
#[[file:.kiro/specs/{feature_name}/requirements.md]]
#[[file:.kiro/specs/{feature_name}/tasks.md]]
```

#### Management One-Pager Steering File Template
```markdown
---
inclusion: manual
generatedBy: pm-agent-intent-optimizer
generatedAt: {timestamp}
featureName: {feature_name}
documentType: onepager
---

# Executive Guidance: {Feature Name}

This executive-level guidance follows the Pyramid Principle and provides ROI analysis for stakeholder communication.

{one-pager content with ROI tables}

## Related Documents
#[[file:.kiro/specs/{feature_name}/requirements.md]]
#[[file:.kiro/specs/{feature_name}/design.md]]
```

## Error Handling

### File System Errors
- **Permission Issues**: Graceful fallback with user notification
- **Disk Space**: Check available space before writing large steering files
- **Path Conflicts**: Automatic resolution with versioning or user prompt

### Content Processing Errors
- **Malformed Documents**: Validation and sanitization before steering file creation
- **Missing References**: Graceful handling of broken file references
- **Template Errors**: Fallback to basic steering file format

### Integration Errors
- **MCP Tool Failures**: Steering file generation should not block main PM agent functionality
- **Pipeline Errors**: Isolated error handling to prevent cascade failures

## Testing Strategy

### Unit Tests
- SteeringFileGenerator component tests with various document types
- FrontMatterProcessor tests for different inclusion rules
- DocumentReferenceLinker tests for cross-reference accuracy
- SteeringFileManager tests for naming and conflict resolution

### Integration Tests
- End-to-end tests: PM agent output â†’ steering file creation
- File system integration tests with various scenarios
- MCP tool integration tests with steering file options
- Cross-document reference validation tests

### Performance Tests
- Large document processing performance
- Concurrent steering file creation
- File system operation efficiency
- Memory usage during bulk steering file generation

## Implementation Phases

### Phase 1: Core Infrastructure
- Implement SteeringFileGenerator and basic templates
- Create FrontMatterProcessor with standard inclusion rules
- Add basic file system operations in SteeringFileManager

### Phase 2: MCP Integration
- Extend MCP tool handlers with steering file options
- Add user prompts for steering file creation preferences
- Implement conflict resolution and naming strategies

### Phase 3: Advanced Features
- Add DocumentReferenceLinker for cross-references
- Implement intelligent inclusion rule suggestions
- Add steering file management and cleanup utilities

### Phase 4: User Experience
- Create steering file preview before saving
- Add bulk steering file operations
- Implement steering file analytics and usage tracking